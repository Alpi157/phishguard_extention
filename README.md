# PHISHGUARD KZ
**Расширение-щит от фишинга и вредоносных ссылок**  
**Версия:** 0.3.1

---

## СОДЕРЖАНИЕ

1. Назначение и ключевые возможности  
2. Быстрый старт для конечного пользователя  
3. Структура репозитория  
4. Техническая архитектура  
5. Подробности реализации подсистем  
   - 5.1 Расширение Chrome / Edge  
   - 5.2 Локальный сервер Flask  
   - 5.3 ONNX модель RuBERT tiny2 (дообучение на 82 000 примеров)  
   - 5.4 GPT объяснение (OpenAI API)  
   - 5.5 Модуль статического анализа HTML / JS  
   - 5.6 Песочница Hybrid Analysis  
   - 5.7 AdBlock (EasyList + Казахстанские фишинговые домены)  
   - 5.8 SOC дэшборд и централизованный журнал инцидентов  
   - 5.9 Страница расширенного сканирования (VirusTotal + Hybrid Sandbox)  
6. Особенности конфиденциальности и развёртывания on prem   
8. Планы развития и TODO  

---

## 1. НАЗНАЧЕНИЕ И КЛЮЧЕВЫЕ ВОЗМОЖНОСТИ

**PhishGuard KZ** — это клиент-серверное решение, предназначенное для проактивной защиты пользователей Gmail и Outlook Web от фишинга, вредоносных ссылок и вирусных вложений.

Отличительные особенности:
- Инференс ONNX модели и первичный анализ проходят **локально**
- Человеко-читаемое объяснение риска от **GPT**
- Поддержка **русского и казахского языков**

### Краткий список возможностей:

- Локальная ML-модель (RuBERT tiny2) анализирует текст письма
- GPT объяснение (до 2000 писем/мес. в тарифе Pro)
- Расширенный анализ HTML / JS
- Поддержка локальных брендов (Kaspi, Halyk, eGov и др.)
- QR-сканирование ссылок
- Интеграция с VirusTotal и Hybrid Analysis
- Завеса при клике на подозрительную ссылку
- AdBlock с динамической активацией
- SOC дэшборд с графиками и AI-подсказками
- Поддержка развёртывания on-prem / Private Cloud


---

## Сравнение PhishGuard KZ с альтернативами

| Функция / Решение                          | PhishGuard KZ | Google Safe Browsing | Microsoft Defender | Proofpoint Essentials | ZeroFox / Cofense |
|-------------------------------------------|:--------------:|:---------------------:|:------------------:|:----------------------:|:------------------:|
| Поддержка брендов РК (Kaspi, Halyk…)      | ✔              | ✖                    | ✖                 | ✖                     | ✖                 |
| Локальная ML‑модель (офлайн‑инференс)     | ✔              | ✖                    | ✖                 | ✖                     | ✖                 |
| GPT‑объяснение (рус/каз)                  | ✔              | ✖                    | ✖                 | ✖                     | ✖                 |
| HTML/JS‑анализ сайтов                     | ✔              | ∼                    | ✖                 | ∼                     | ✔                 |
| Анализ вложений (PDF, DOCX, HTML…)        | ✔              | ✖                    | ∼                 | ✔                     | ✔                 |
| VirusTotal / Hybrid Analysis              | ✔              | ∼                    | ✖                 | ✔                     | ✔                 |
| SOC‑дэшборд, аналитика                    | ✔ (Enterprise) | ✖                    | ✔                 | ✔                     | ✔                 |
| On‑prem / Private Cloud                   | ✔              | ✖                    | ∼                 | ∼                     | ✔                 |
| Интерфейс на русском/казахском           | ✔              | ∼                    | ∼                 | ✖                     | ✖                 |
| Интеграция в Gmail, Outlook               | ✔              | ∼                    | ✖                 | ∼                     | ✖                 |

**Легенда:**  
✔ — Полная поддержка  
∼ — Частичная поддержка  
✖ — Отсутствует поддержка

---

## 2. БЫСТРЫЙ СТАРТ ДЛЯ КОНЕЧНОГО ПОЛЬЗОВАТЕЛЯ

### Шаг 1 — Установить расширение в браузер
- **Chrome / Edge**: Включить Developer Mode → Load unpacked → выбрать репозиторий

### Шаг 2 — Запустить локальный сервер
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python server.py
```

### Шаг 3 — Настройка API ключей
- В popup расширения указать **OpenAI API ключ** (`sk-...`)
- При необходимости задать ключи **VirusTotal** и **Hybrid Analysis**


---

## 3. СТРУКТУРА РЕПОЗИТОРИЯ

- `assets/` — иконки, логотип  
- `libs/` — `jsqr.min.js` и другие сторонние скрипты  
- `phishguard_model_onnx/` — ONNX файлы RuBERT tiny2  
- `static/` — `dashboard.css`, `index.js` (интерфейс сканера)  
- `templates/` — `dashboard.html`, `index.html`, `plans.html`  
- `uploads/` — временное хранилище файлов для песочницы  
- `background.js` — service worker расширения  
- `content.js` — скрипт, работающий во вкладке Gmail / Outlook  
- `manifest.json` — манифест расширения (MV3)  
- `popup.{html,css,js}` — интерфейс и логика всплывающего окна  
- `server.py` — единый Flask сервер (API + дэшборд + сканер)  
- `filters.json` — правила EasyList + казахстанские фишинговые домены  
- `incidents.jsonl` — журнал инцидентов (JSONL формат, ротация cron)

---

## 4. ТЕХНИЧЕСКАЯ АРХИТЕКТУРА

```
┌───────────┐ content.js ┌──────────────┐ HTTP/REST ┌───────────────┐
│  Gmail    │←──────────→│ background   │←─────────→│ Flask server  │
│  Outlook  │ postMessage│ service WK   │ 127.0.0.1 │  (server.py)  │
└───────────┘ └──────────────┘             └───────────────┘
       │ локальные вызовы / Web Worker
       │
       │ ONNX runtime (web)
       └────── ML модель RuBERT tiny2 ──────┘
```

- Инференс ONNX происходит в браузере (WebAssembly) или на локальном сервере (CPU).
- `background.js` взаимодействует с OpenAI API, Hybrid Analysis и AdBlock.
- Все внешние вызовы (VT, HA, GPT) идут через service worker — полностью совместимо с Manifest V3.

---

## 5. ПОДРОБНОСТИ ПОДСИСТЕМ

### 5.1 Расширение Chrome / Edge / Firefox

- Manifest V3, CSP: `script-src 'self'`
- Popup включает вкладки: «Письмо», «URL», «Настройки»
- `content.js` использует `MutationObserver` для слежения за письмами

### 5.2 Flask сервер

- `/` — расширенное сканирование (`index.html`)
- `/dashboard` — SOC дэшборд (графики `Chart.js`)
- `/classify`, `/url` — API для ML-модели
- `/api/*` — прокси к VirusTotal и Hybrid Analysis
- `/incidents`, `/incident` — работа с `incidents.jsonl`

### 5.3 ONNX модель

- RuBERT tiny2 (93 МБ)
- Дообучение на 92k писем
- Accuracy ≈ 0.95, threshold = 0.50

### 5.4 GPT объяснение

- GPT-4o mini, температура 0.2, макс. 200 токенов
- Возврат строго в JSON по system prompt
- Приватные данные обфусцируются перед отправкой

### 5.5 HTML/JS анализ

- Загружается HTML, ищутся теги `<input>`, `iframe`, `eval`, IP-скрипты
- До 3 внешних JS загружаются (по 4 КБ)
- Метаданные и фрагменты анализируются GPT-аудитором

### 5.6 Hybrid Analysis

- Env ID: 100 (Windows 10)
- `/submit/url`, `/submit/file` → `job_id` → polling
- Ограничение: файлы до 25 МБ

### 5.7 AdBlock

- `filters.json` ≈ 18 000 правил (EasyList + 2 000 KZ-доменов)
- Используется `updateDynamicRules` (до 30k)

### 5.8 SOC дэшборд

- Четыре графика: risk, daily, weekly, top users
- GPT анализирует и выводит ключевые векторы атак
- Drill-down на основе клика по графику

### 5.9 Расширенный сканер

- Основан на `index.html` + Bootstrap 5
- Формы: URL, домен, файл (≤32 МБ)
- Поддержка Hybrid Analysis с отложенным анализом
- Цветовая граница результата: `success`, `warning`, `danger`


---

## 6. КОНФИДЕНЦИАЛЬНОСТЬ И ON PREM

- Полный текст писем **никогда не покидает локальный хост**. В GPT передаётся только **обезличенный summary** объёмом до 1 КБ.
- Поддерживается развёртывание **on prem**:
  ```bash
  docker compose up
  ```
  Укажите переменную `OPENAI_PROXY` или используйте свой Azure OpenAI endpoint.
- SOC дэшборд можно поднять во внутреннем сегменте:
  - Интеграция через **Syslog / Kafka** для передачи в SIEM

---

## 7.  ПЛАНЫ РАЗВИТИЯ

- **Мобильное SDK** (Android Share Target + MLKit)
- Расширение для **Thunderbird** и **Outlook Desktop (MIP Add-ins)**
- Модели **Vision + NLP** для анализа вложенных изображений
- **IAM аутентификация** для Scanner UI (OIDC / Azure AD)
- Поддержка шаблонов из **СНГ**
- Автоматическая ротация `incidents.jsonl` → S3 / Minio (Parquet формат)

---

© 2025 PhishGuard KZ

